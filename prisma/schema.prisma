generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enhanced schema to support multi-client dossier creation

// NEW MODEL: Dossier Batch (for creating multiple dossiers at once)
model DossierBatch {
  id               Int              @id @default(autoincrement())
  nom              String           // Base name for the batch
  description      String?
  periode          String?          // e.g., "Janvier 2024", "Q1 2024"
  dateEcheance     DateTime?
  dateCreation     DateTime         @default(now())
  dateModification DateTime         @updatedAt
  comptableId      Int
  dossierTemplateId Int?
  comptable        Comptable        @relation(fields: [comptableId], references: [id])
  dossierTemplate  DossierTemplate? @relation(fields: [dossierTemplateId], references: [id])
  dossiers         Dossier[]        // Individual dossiers created from this batch

  @@map("dossier_batches")
}

// MODIFIED MODEL: Dossier - now linked to a batch
model Dossier {
  id                Int                 @id @default(autoincrement())
  nom               String              // Will be generated as "{batch.nom} - {client.raisonSociale}"
  description       String?
  periode           String?             // e.g., "Janvier 2024", "Q1 2024"
  dateEcheance      DateTime?
  status            StatusDossier       @default(EN_ATTENTE)
  pourcentage       Float               @default(0) // Completion percentage
  documentsUpload   Int                 @default(0) // Number of documents uploaded
  documentsRequis   Int                 @default(0) // Total required documents
  dateCreation      DateTime            @default(now())
  dateModification  DateTime            @updatedAt
  dateCompletion    DateTime?
  clientId          Int
  comptableId       Int
  dossierTemplateId Int?
  dossierBatchId    Int?                // NEW: Link to batch
  client            Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  comptable         Comptable           @relation(fields: [comptableId], references: [id])
  dossierTemplate   DossierTemplate?    @relation(fields: [dossierTemplateId], references: [id])
  dossierBatch      DossierBatch?       @relation(fields: [dossierBatchId], references: [id])
  documentRequests  DocumentRequest[]   // Specific document requests for this dossier
  formulaires       Formulaire[]        // Link to formulaires for this dossier

  @@map("dossiers")
}

// MODIFIED MODEL: Add batch relation to Comptable
model Comptable {
  id               Int            @id @default(autoincrement())
  userId           Int            @unique
  cabinet          String
  specialites      String[]
  numeroOrdre      String?
  dateCreation     DateTime       @default(now())
  dateModification DateTime       @updatedAt
  clients          Client[]
  documents        Document[]
  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  notifications    Notification[]
  taches           Tache[]
  templates        Template[]
  dynamicForms     DynamicForm[]
  dossierTemplates DossierTemplate[]
  documentRequests DocumentRequest[]
  dossiers         Dossier[]
  dossierBatches   DossierBatch[]      // NEW: Batches created by comptable
  factures         Facture[]

  @@map("comptables")
}

// MODIFIED MODEL: Add batch relation to DossierTemplate
model DossierTemplate {
  id               Int                        @id @default(autoincrement())
  nom              String
  description      String?
  typeActivite     String?
  regimeFiscal     String?
  periode          PeriodeDossier
  actif            Boolean                    @default(true)
  dateCreation     DateTime                   @default(now())
  dateModification DateTime                   @updatedAt
  comptableId      Int
  comptable        Comptable                  @relation(fields: [comptableId], references: [id])
  documentsRequis  DocumentTemplateRequis[]
  dossiers         Dossier[]
  dossierBatches   DossierBatch[]             // NEW: Batches using this template

  @@map("dossier_templates")
}

// Rest of the existing models remain the same...
model User {
  id               Int        @id @default(autoincrement())
  nom              String
  email            String     @unique
  password         String
  dateCreation     DateTime   @default(now())
  dateModification DateTime   @updatedAt
  actif            Boolean    @default(true)
  role             Role       @default(COMPTABLE)
  client           Client?
  comptable        Comptable?

  @@map("users")
}

model Client {
  id                Int              @id @default(autoincrement())
  userId            Int              @unique
  siret             String           @unique
  raisonSociale     String
  adresse           String?
  codePostal        String?
  ville             String?
  telephone         String?
  typeActivite      String?
  regimeFiscal      String?
  derniereConnexion DateTime?
  comptableId       Int
  comptable         Comptable        @relation(fields: [comptableId], references: [id])
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents         Document[]
  echeances         Echeance[]
  emailLogs         EmailLog[]
  formulaires       Formulaire[]
  notifications     Notification[]
  taches            Tache[]
  templates         TemplateClient[]
  dynamicFormResponses DynamicFormResponse[]
  dossiers          Dossier[]
  documentRequests  DocumentRequest[]
  caisses           Caisse[]         // NEW: Add caisses relation
  factures          Facture[]


  @@map("clients")
}


model DocumentTemplateRequis {
  id                Int             @id @default(autoincrement())
  dossierTemplateId Int
  typeDocument      TypeDocument
  obligatoire       Boolean         @default(true)
  description       String?
  quantiteMin       Int             @default(1)
  quantiteMax       Int?
  formatAccepte     String[]
  tailleMaxMo       Int             @default(10)
  dossierTemplate   DossierTemplate @relation(fields: [dossierTemplateId], references: [id], onDelete: Cascade)

  @@unique([dossierTemplateId, typeDocument])
  @@map("documents_template_requis")
}

model DocumentRequest {
  id               Int                    @id @default(autoincrement())
  titre            String
  description      String?
  typeDocument     TypeDocument
  obligatoire      Boolean                @default(true)
  quantiteMin      Int                    @default(1)
  quantiteMax      Int?
  formatAccepte    String[]
  tailleMaxMo      Int                    @default(10)
  status           StatusDocumentRequest  @default(EN_ATTENTE)
  dateCreation     DateTime               @default(now())
  dateEcheance     DateTime?
  dateCompletion   DateTime?
  instructions     String?
  clientId         Int
  comptableId      Int
  dossierId        Int?
  formulaireId     Int?
  client           Client                 @relation(fields: [clientId], references: [id], onDelete: Cascade)
  comptable        Comptable              @relation(fields: [comptableId], references: [id])
  dossier          Dossier?               @relation(fields: [dossierId], references: [id])
  formulaire       Formulaire?            @relation(fields: [formulaireId], references: [id])
  uploads          DocumentUpload[]

  @@map("document_requests")
}

model DocumentUpload {
  id                Int             @id @default(autoincrement())
  documentId        Int
  documentRequestId Int
  status            StatusUpload    @default(VALIDE)
  commentaire       String?
  dateUpload        DateTime        @default(now())
  dateValidation    DateTime?
  document          Document        @relation(fields: [documentId], references: [id], onDelete: Cascade)
  documentRequest   DocumentRequest @relation(fields: [documentRequestId], references: [id], onDelete: Cascade)

  @@unique([documentId, documentRequestId])
  @@map("document_uploads")
}

// Include all other existing models...
model Template {
  nom              String
  subject          String
  content          String
  type             TemplateType
  actif            Boolean          @default(true)
  dateCreation     DateTime         @default(now())
  dateModification DateTime         @updatedAt
  comptableId      Int
  category         String
  usageCount       Int              @default(0)
  variables        String[]
  id               Int              @id @default(autoincrement())
  cronExpression   String?
  isPeriodic       Boolean          @default(false)
  lastExecutionAt  DateTime?
  nextExecutionAt  DateTime?
  includeForm      Boolean          @default(false)
  dynamicFormId    Int?
  emailLogs        EmailLog[]
  clients          TemplateClient[]
  comptable        Comptable        @relation(fields: [comptableId], references: [id])
  dynamicForm      DynamicForm?     @relation(fields: [dynamicFormId], references: [id])

  @@map("templates")
}

model DynamicForm {
  id                   Int                   @id @default(autoincrement())
  title                String
  description          String?
  fields               Json
  expirationDays       Int                   @default(30)
  requiresAuthentication Boolean             @default(true)
  isActive             Boolean               @default(true)
  dateCreation         DateTime              @default(now())
  dateModification     DateTime              @updatedAt
  comptableId          Int
  comptable            Comptable             @relation(fields: [comptableId], references: [id])
  templates            Template[]
  responses            DynamicFormResponse[]

  @@map("dynamic_forms")
}

model DynamicFormResponse {
  id               Int         @id @default(autoincrement())
  responses        Json
  status           FormResponseStatus @default(PENDING)
  dateCreation     DateTime    @default(now())
  dateCompletion   DateTime?
  dateExpiration   DateTime
  ipAddress        String?
  userAgent        String?
  isRead           Boolean     @default(false)  // NEW: Track if comptable has read the response
  dateRead         DateTime?                    // NEW: When it was read
  clientId         Int
  dynamicFormId    Int
  emailLogId       Int?
  client           Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  dynamicForm      DynamicForm @relation(fields: [dynamicFormId], references: [id], onDelete: Cascade)
  emailLog         EmailLog?   @relation(fields: [emailLogId], references: [id])

  @@map("dynamic_form_responses")
}

model TemplateClient {
  id              Int      @id @default(autoincrement())
  templateId      Int
  clientId        Int
  dateAssignation DateTime @default(now())
  actif           Boolean  @default(true)
  client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  template        Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, clientId])
  @@map("template_clients")
}

model EmailLog {
  id          Int          @id @default(autoincrement())
  subject     String
  content     String
  token       String       @unique @default(uuid())
  status      EmailStatus  @default(SENT)
  messageId   String?
  error       String?
  sentAt      DateTime     @default(now())
  openedAt    DateTime?
  clickedAt   DateTime?
  respondedAt DateTime?
  templateId  Int
  clientId    Int
  client      Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  template    Template     @relation(fields: [templateId], references: [id])
  formulaires Formulaire[]
  dynamicFormResponses DynamicFormResponse[]

  @@map("email_logs")
}

model Formulaire {
  id             Int              @id @default(autoincrement())
  titre          String
  description    String?
  champs         Json
  reponses       Json?
  status         FormulaireStatus @default(PENDING)
  dateCreation   DateTime         @default(now())
  dateCompletion DateTime?
  dateExpiration DateTime?
  clientId       Int
  emailLogId     Int?
  dossierId      Int?
  documents      Document[]
  client         Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  emailLog       EmailLog?        @relation(fields: [emailLogId], references: [id])
  dossier        Dossier?         @relation(fields: [dossierId], references: [id])
  documentRequests DocumentRequest[]

  @@map("formulaires")
}

model Document {
  id               Int          @id @default(autoincrement())
  nom              String
  nomOriginal      String
  chemin           String
  taille           Int
  typeDocument     TypeDocument
  typeFichier      String
  dateUpload       DateTime     @default(now())
  dateModification DateTime     @updatedAt
  clientId         Int
  comptableId      Int
  formulaireId     Int?
  client           Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  comptable        Comptable    @relation(fields: [comptableId], references: [id])
  formulaire       Formulaire?  @relation(fields: [formulaireId], references: [id])
  uploads          DocumentUpload[]

  @@map("documents")
}

// Add this model to your existing Prisma schema

model Caisse {
  id               Int      @id @default(autoincrement())
  nom              String   // Name of the caisse (CNAV, URSSAF, etc.)
  username         String?  // Username for connection
  password         String?  // Encrypted password
  isActive         Boolean  @default(false)
  dateCreation     DateTime @default(now())
  dateModification DateTime @updatedAt
  clientId         Int
  comptableId      Int
  client           Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, nom])
  @@map("caisses")
}

model Tache {
  id             Int         @id @default(autoincrement())
  titre          String
  description    String?
  type           TypeTache
  priorite       Priorite    @default(MOYENNE)
  status         StatusTache @default(PENDING)
  dateCreation   DateTime    @default(now())
  dateEcheance   DateTime?
  dateCompletion DateTime?
  clientId       Int
  comptableId    Int
  echeances      Echeance[]
  client         Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  comptable      Comptable   @relation(fields: [comptableId], references: [id])

  @@map("taches")
}

model Echeance {
  id           Int            @id @default(autoincrement())
  titre        String
  description  String?
  type         TypeEcheance
  dateEcheance DateTime
  dateRappel   DateTime?
  status       StatusEcheance @default(ACTIVE)
  montant      Float?
  reference    String?
  clientId     Int
  tacheId      Int?
  client       Client         @relation(fields: [clientId], references: [id], onDelete: Cascade)
  tache        Tache?         @relation(fields: [tacheId], references: [id])

  @@map("echeances")
}

model Notification {
  id           Int              @id @default(autoincrement())
  titre        String
  message      String
  type         TypeNotification
  lu           Boolean          @default(false)
  dateCreation DateTime         @default(now())
  dateLecture  DateTime?
  clientId     Int?
  comptableId  Int?
  client       Client?          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  comptable    Comptable?       @relation(fields: [comptableId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model JobCron {
  id                 Int            @id @default(autoincrement())
  nom                String
  description        String?
  expression         String
  type               TypeJob
  actif              Boolean        @default(true)
  derniereExecution  DateTime?
  prochaineExecution DateTime?
  parametres         Json?
  dateCreation       DateTime       @default(now())
  logs               LogExecution[]

  @@map("jobs_cron")
}

model LogExecution {
  id            Int             @id @default(autoincrement())
  jobId         Int
  status        StatusExecution
  message       String?
  duree         Int?
  dateExecution DateTime        @default(now())
  job           JobCron         @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@map("logs_execution")
}

model Facture {
  id               Int              @id @default(autoincrement())
  numero           String           @unique // FAC-2024-12-001-00542
  dateEmission     DateTime         @default(now())
  dateEcheance     DateTime
  status           StatusFacture    @default(BROUILLON)
  notes            String?
  totalHT          Float            @default(0)
  totalTVA         Float            @default(0)
  totalTTC         Float            @default(0)
  dateCreation     DateTime         @default(now())
  dateModification DateTime         @updatedAt
  dateValidation   DateTime?
  dateEnvoi        DateTime?
  datePaiement     DateTime?
  clientId         Int
  comptableId      Int
  client           Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  comptable        Comptable        @relation(fields: [comptableId], references: [id])
  lignes           LigneFacture[]

  @@map("factures")
}

model LigneFacture {
  id             Int      @id @default(autoincrement())
  description    String
  quantite       Int
  prixUnitaire   Float
  tauxTVA        Float    @default(20)
  montantHT      Float
  montantTVA     Float
  montantTTC     Float
  ordre          Int      @default(0)
  factureId      Int
  facture        Facture  @relation(fields: [factureId], references: [id], onDelete: Cascade)

  @@map("lignes_factures")
}

enum Role {
  ADMIN
  CLIENT
  COMPTABLE
}

enum EmailStatus {
  DRAFT
  SENT
  OPENED
  CLICKED
  RESPONDED
  FAILED
}

enum TemplateType {
  REMINDER
  INVOICE
  INFO
  CUSTOM
}

enum FormulaireStatus {
  PENDING
  STARTED
  COMPLETED
  EXPIRED
  CANCELLED
}

enum FormResponseStatus {
  PENDING
  STARTED
  COMPLETED
  EXPIRED
  CANCELLED
}

enum TypeDocument {
  FACTURE_VENTE
  FACTURE_ACHAT
  RELEVE_BANCAIRE
  BULLETIN_PAIE
  JUSTIFICATIF
  CONTRAT
  DECLARATION
  AUTRE
}

enum TypeTache {
  TVA
  SOCIAL
  BILAN
  LIASSE_FISCALE
  RELANCE_CLIENT
  AUTRE
}

enum Priorite {
  BASSE
  MOYENNE
  HAUTE
  URGENTE
}

enum StatusTache {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  OVERDUE
}

enum TypeEcheance {
  TVA_MENSUELLE
  TVA_TRIMESTRIELLE
  CHARGES_SOCIALES
  DECLARATION_ANNUELLE
  LIASSE_FISCALE
  AUTRE
}

enum StatusEcheance {
  ACTIVE
  COMPLETED
  CANCELLED
  OVERDUE
}

enum TypeNotification {
  EMAIL_ENVOYE
  FORMULAIRE_COMPLETE
  ECHEANCE_PROCHE
  TACHE_ASSIGNEE
  DOCUMENT_RECU
  RAPPEL
  ERREUR
}

enum TypeJob {
  ENVOI_EMAIL
  RAPPEL_ECHEANCE
  NETTOYAGE_FICHIERS
  SAUVEGARDE
  STATISTIQUES
  ENVOI_EMAIL_TEMPLATE
}

enum StatusExecution {
  SUCCESS
  ERROR
  WARNING
  CANCELLED
}

enum PeriodeDossier {
  MENSUEL
  TRIMESTRIEL
  SEMESTRIEL
  ANNUEL
  PONCTUEL
}

enum StatusDossier {
  EN_ATTENTE
  EN_COURS
  COMPLET
  VALIDE
  REFUSE
  EXPIRE
}

enum StatusDocumentRequest {
  EN_ATTENTE
  RECU
  VALIDE
  REFUSE
  EXPIRE
}

enum StatusUpload {
  VALIDE
  EN_REVISION
  REFUSE
  REMPLACE
}


enum StatusFacture {
  BROUILLON
  VALIDEE
  ENVOYEE
  PAYEE
  ANNULEE
  EN_RETARD
}